<!doctype html>
<html>
<head>

</head>
<body>
  <div id="pie"></div>
	<script src="https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js"></script>
	<script src="http://cdnjs.cloudflare.com/ajax/libs/underscore.js/1.3.3/underscore-min.js"></script>
	<script src="http://cdnjs.cloudflare.com/ajax/libs/d3/2.8.1/d3.v2.min.js"></script>
	<script>
	$(function(){
    var cleanTaxData = [];
		var stateTaxData = [];

		$.get('/govdata/wvps-imhx/rows.json')
		.then(function(data, status, xhr) {
			//console.log(data);
      cleanTaxData = shapeData(data);
      stateTaxData = getSummaryData(cleanTaxData);
      //console.log(stateTaxData);
      buildPieChart(stateTaxData);
		});
	});
	
	// now using the following example
	// http://bl.ocks.org/2295263
	var buildPieChart = function(data) {	
  	var m = 76,
  	    r = 400,
  	    z = d3.scale.category20c(),
  	    outerRadius = 50;
  	
  	// the SVG    
    var svg = d3.select("body")
      .selectAll("svg")
      .data(data)
      .enter().append("svg:svg")
      .attr("width", (r + m) * 2)
      .attr("height", (r + m) * 2)
      .append("svg:g")
      .attr("transform", "translate(" + (r + m) + "," + (r + m) + ")");
  
  	// some supporting elements, pie & arc
    var pie = d3.layout.pie()
      .value(function(d) { return d.income; });

		var arc = d3.svg.arc()
		      .outerRadius(outerRadius);

    var arcs = svg.selectAll("path")
      .data(pie)
      .enter().append("svg:path")
      .attr("d", d3.svg.arc()
      .outerRadius(r))
      .style("fill", function(d, i) { return z(i); });
      
    // add label legend to each arc
		arcs.append("svg:text")
		  .attr("transform", function(d) { //set the label's origin to the center of the arc
		    //we have to make sure to set these before calling arc.centroid
		    d.outerRadius = outerRadius + 50; // Set Outer Coordinate
		    d.innerRadius = outerRadius + 45; // Set Inner Coordinate
		    return "translate(" + arc.centroid(d) + ")";
		  })
		  .attr("text-anchor", "middle") //center the text on it's origin
		  .style("fill", "Purple")
		  .style("font", "bold 12px Arial")
		  .text(function(d, i) { return d.data.state; });
     
		// Add a magnitude value to the larger arcs, translated to the arc centroid and rotated.
		arcs.filter(function(d) { return d.endAngle - d.startAngle > .2; }).append("svg:text")
		  .attr("dy", ".35em")
		  .attr("text-anchor", "middle")
		  //.attr("transform", function(d) { return "translate(" + arc.centroid(d) + ")rotate(" + angle(d) + ")"; })
		  .attr("transform", function(d) { //set the label's origin to the center of the arc
		    //we have to make sure to set these before calling arc.centroid
		    d.outerRadius = outerRadius; // Set Outer Coordinate
		    d.innerRadius = outerRadius/2; // Set Inner Coordinate
		    return "translate(" + arc.centroid(d) + ")rotate(" + angle(d) + ")";
		  })
		  .style("fill", "White")
		  .style("font", "bold 12px Arial")
		  .text(function(d) { return d.data.magnitude; });
     
     
		// Computes the angle of an arc, converting from radians to degrees.
		function angle(d) {
		  var a = (d.startAngle + d.endAngle) * 90 / Math.PI - 90;
		  return a > 90 ? a - 180 : a;
		}
	};
	

	
	var getSummaryData = function(data) {
    var retval = [];
    $.each(data, function(ii, row) {
      if (row.county_code === "0") {
        retval.push( {
          state: row.state_abbreviation,
          income: row.wages_and_salaries_incomes_in_thousands
        });
      }
    });
    return [retval];
	};
	
	var shapeData = function(data) {
    var retval = [];
    $.each(data.data, function(ii, item) {
      retval.push({
        "state_code": item[8],
        "county_code": item[9],
        "state_abbreviation": item[10],
        "county_name": item[11],
        "total_number_of_tax_returns": item[12],
        "total_number_of_exemptions": item[13],
        "adjusted_gross_income_in_thousands": item[14],
        "wages_and_salaries_incomes_in_thousands": item[15],
        "dividend_incomes_in_thousands": item[16],
        "interest_income_in_thousands": item[17]
      });
    });
    return retval;
	};
  
  
  /*
  8 + position gives the array index of the field
  8 + index of cols[] is the same
  */
  var cols = [
    {
      id: 2704296,
      name: "State Code",
      dataTypeName: "number",
      fieldName: "state_code"
    },
    {
      id: 2704297,
      name: "County Code",
      dataTypeName: "number",
      description: "ID 0 represents the total for the whole state.",
      fieldName: "county_code"
    },
    {
      id: 2704298,
      name: "State Abbreviation",
      dataTypeName: "text",
      fieldName: "state_abbreviation"
    },
    {
      id: 2704299,
      name: "County Name",
      dataTypeName: "text",
      fieldName: "county_name"
    },
    {
      id: 2704300,
      name: "Total Number of Tax Returns",
      dataTypeName: "number",
      fieldName: "total_number_of_tax_returns"
    },
    {
      id: 2704301,
      name: "Total Number of Exemptions",
      dataTypeName: "number",
      description: "Excluding the deceased.",
      fieldName: "total_number_of_exemptions"
    },
    {
      id: 2707313,
      name: "Adjusted Gross Income (In Thousands)",
      dataTypeName: "money",
      fieldName: "adjusted_gross_income_in_thousands"
    },
    {
      id: 2707314,
      name: "Wages and Salaries Incomes (In Thousands)",
      dataTypeName: "money",
      fieldName: "wages_and_salaries_incomes_in_thousands"
    },
    {
      id: 2707315,
      name: "Dividend Incomes (In Thousands)",
      dataTypeName: "money",
      fieldName: "dividend_incomes_in_thousands"
    },
    {
      id: 2707316,
      name: "Interest Income (In Thousands)",
      dataTypeName: "money",
      fieldName: "interest_income_in_thousands"
    }
  ];
	</script>
</body>
</html>
